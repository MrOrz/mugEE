<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js" type="text/javascript"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.13/jquery-ui.min.js" type="text/javascript"></script>
  <script src="jquery.colors.pickers.hslLite.bundle.min.js" type="text/javascript"></script>
  <script src="jquery.transform-0.9.3.min.js" type="text/javascript"></script>
  <style type="text/css">

  body{
    background: url(images/bg.jpg);
  }

  #ball{
    width: 214px;
    height: 214px;
    margin: -107px;
    background: transparent;
    left: 50%; top: 50%;
    position: absolute;
  }

  #stick{
    width: 45px;   
    border-top: 0;
    -webkit-transform-origin: 50% 100%;
    height: 0;
    position:absolute;
    bottom: 50%;
    left: 256.5px ; /* (558-45)/2 */
  }
  #stick .colored{
    width: 100%;
    height: 85%;
    background: url(images/stick.png) no-repeat left bottom;
  }

  #stick-slot{
    left: 382px; top: 52px;
    width: 558px;
    height: 558px;
    background: url(images/panel.png);
    position: absolute;
  }

  #zoom-slot{
    width: 158px;
    height: 558px;
    left: 130px; top: 52px;
    background: url(images/zoom-bg.png);
    position: absolute;

  }

  #zoom-slot>div{
    margin: 50px 0;
    height: 450px;
    position:relative;
  }
  
  #zoom-slot .ui-slider-handle{
    display:block;
    position: absolute;
    left: 50%;
    margin-left: -40px;
    width: 80px;
    height: 139px;
    margin-bottom: -70px;
    background: url(images/zoom-handle.png);
  }
  
  #presets{
    position:absolute;
    left: 1016px;
    top: 52px;
    width: 158px;
    height: 558px;
  }
  
  .button1, .button2, .button3{
    width: 158px; height: 158px;
    position: absolute;
  }
  
  .button1{
    background: url('images/button1.png');
  }
  
  .button1:hover{
    background: url('images/button1-pressed.png');
  }
  
  .button2{
    background: url('images/button2.png');
    top: 50%; margin-top: -79px;
  }
  
  .button2:hover{
    background: url('images/button2-pressed.png');
  }
  
  .button3{
    background: url('images/button3.png');
    bottom: 0;
  }
  .button3:hover{
    background: url('images/button3-pressed.png');
  }

  #hsl{
    position:absolute;
    left: 80px;
    top: 760px;
    width: 1130px;
    height: 155px;
    background-image: url(images/hsl.png), url(images/hsl.png), url(images/hsl.png);
    background-position: left center, center center, right center;
    background-repeat: no-repeat;
  }
  
  #hsl .scale{
    margin: 33px 55px;
    border-top: 2px solid #333;
    border-left:  2px solid #999;
    border-right: 2px solid #999;
    border-bottom: 2px solid #ccc;
    border-radius: 10px;
  }


</style>

</head>
<body>
  <div id="zoom-slot">
    <div></div>
  </div>
  
  <div id="stick-slot">
    <div id="stick">
      <div class="colored"></div>
    </div>
    <img id="ball" src="images/ball.png" />
  </div>

  <div id="presets">
    <div class="button1"></div>
    <div class="button2"></div>
    <div class="button3"></div>
  </div>

  <div id="hsl">
  
  </div>
  
  <script type="text/javascript">
    
    var $stick = $('#stick'), $ball = $('#ball'), $hsl = $('#hsl'),
      RADIUS = 200, ORIGIN = {left: 279, top: 279}, BALLSIZE = 214,
      SOCKET_TARGET = 'ws://echo.websocket.org',
      //SOCKET_TARGET = 'ws://localhost:9999/',
      HORIZONTAL_STEPSIZE = RADIUS/2, VERTICAL_STEPSIZE = RADIUS / 2;

    Number.prototype.to_deg = function(){
      return this / Math.PI * 180;
    };
    //-----------------------------
    //----- COMMUNICATION PART
    
    var ws = new WebSocket(SOCKET_TARGET);
    ws.onopen = function(e){
      console.log("Socket opens.");
    }
    ws.onmessage = function(e){
      console.log(e.data);
    };

    // joystick coordinates
    setTimeout(function(){
      if(ws.readyState === WebSocket.OPEN){
        // submit only if the ball is not in its original position.
        if($ball.position().left !== ORIGIN.left || $ball.position().top !== ORIGIN.top ) {
          var dx = Math.ceil($ball.x / HORIZONTAL_STEPSIZE - 0.5),
              dy = Math.ceil($ball.y / VERTICAL_STEPSIZE - 0.5);
          ws.send("" + dx + " " + dy);
        }
      }
      
      setTimeout(arguments.callee, 200);
    }, 200);
    
    // zoom slider
    var send_zoom = function(e, ui){
      ws.send(ui.value);
    };
    // presets
    var preset1 = function(){
      ws.send("abs 0 0");
    }, 
        preset2 = function(){
      ws.send("abs 90 0");
    },
        preset3 = function(){
      ws.send("abs 0 45");
    };
    
    // hsl
    var send_hsl = function(){
      //console.log($hsl.hslLiteColorPicker('hsl'));
      ws.send("hsl " + $hsl.hslLiteColorPicker('hsl').join(' '));
    }
    
    
    //----- END OF COMMUNICATION PART
    //-------------------------------
    
    // let $stick stick with the ball
    $stick.with_ball = function(){
      // get stick angle theta
      var theta = 90-Math.atan($ball.y/$ball.x).to_deg();
      if($ball.x<0){
        theta -= 180;
      }

 //     console.log($ball.x, $ball.y, theta);
      $stick.transform({
        rotate: '' + theta + 'deg'
      }).css( 'height', '' + $ball.dist + 'px' );
    };

    // resizes the ball
    $ball.resize = function(){
      /*var phi = 90 - Math.asin($ball.dist/(RADIUS*2)).to_deg(),
          side = '' + BALLSIZE/(1+(90-phi)/160) + 'px';
      $ball.css('width', side)
           .css('height', side);*/
    }

    // adjust all things about the ball when the ball is animating
    var animate_ball = function(){
      var pos = $ball.position();
      $ball.x = pos.left - ORIGIN.left, 
      $ball.y = (pos.top - ORIGIN.top) * -1;
      $ball.dist = Math.sqrt($ball.x*$ball.x+$ball.y*$ball.y); // calculate ball's distance to center

      $stick.with_ball();
      $ball.resize();
    }

    $ball.draggable({
      containment: "parent",
      drag: animate_ball,
      grid: [HORIZONTAL_STEPSIZE, VERTICAL_STEPSIZE] ,
      stop: function(){
        $ball.animate({
          left: '' + ORIGIN.left + 'px', 
          top: '' + ORIGIN.top + 'px'
        }, {
          step: animate_ball
        });
      }
    });

    $('#zoom-slot>div').slider({
      orientation: "vertical",
      min: 0.5,
      max: 1.5,
      step: 0.05,
      value: 1,
      slide: send_zoom
    });
  
    $('.button1').click(preset1);
    $('.button2').click(preset2);
    $('.button3').click(preset3);
    
    $hsl.hslLiteColorPicker({onChange: send_hsl, hsl:[360, 100, 100]});

    // styling hsl
    $hsl.find('.scale').css({position: 'absolute', height: '50px'});
    $hsl.find('.scale.s').css({left: '50%', marginLeft: '-100px' });
    $hsl.find('.scale.l').css({right: '0'});
    
    
  </script>
</body>
</html>
