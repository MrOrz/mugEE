<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js" type="text/javascript"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.13/jquery-ui.min.js" type="text/javascript"></script>
  <script src="jquery.transform-0.9.3.min.js" type="text/javascript"></script>
  <style type="text/css">

  body{
    background: url(images/bg.jpg);
  }

  #ball{
    width: 214px;
    height: 214px;
    margin: -107px;
    background: transparent;
    left: 50%; top: 50%;
    position: absolute;
  }

  #stick{
    width: 45px;   
    border-top: 0;
    -webkit-transform-origin: 50% 100%;
    height: 0;
    position:absolute;
    bottom: 50%;
    left: 256.5px ; /* (558-45)/2 */
    
  }
  #stick .colored{
    width: 100%;
    height: 85%;
    background: url(images/stick.png) no-repeat left bottom;
  }

  #stick-slot{
    width: 558px;
    height: 558px;
    background: url(images/panel.png);
    position: absolute;
    left: 500px; top: 100px;
  }

  #zoom-slot{
    width: 150px;
    height: 300px;
    border: 1px solid #ccffcc;
  }

  .vertical-sider{
    width: 50px;
    height: 140px;
    border: 1px solid green;  
  }

  
  </style>

</head>
<body>
  <div id="stick-slot">
    <div id="stick">
      <div class="colored"></div>
    </div>
    <img id="ball" src="images/ball.png" />
  </div>
  <div id="zoom-slot">
    <div id="zoom" class="vertical-slider"></div>
  </div>

  <script type="text/javascript">
    
    var $stick = $('#stick'), $ball = $('#ball'),
      RADIUS = 200, ORIGIN = {left: 279, top: 279}, BALLSIZE = 214,
      SOCKET_TARGET = 'ws://echo.websocket.org',
      //SOCKET_TARGET = 'ws://localhost:9999/',
      HORIZONTAL_STEPSIZE = RADIUS/2, VERTIVAL_STEPSIZE = RADIUS / 2;

    Number.prototype.to_deg = function(){
      return this / Math.PI * 180;
    };


    // let $stick stick with the ball
    $stick.with_ball = function(){
      // get stick angle theta
      var theta = 90-Math.atan($ball.y/$ball.x).to_deg();
      if($ball.x<0){
        theta -= 180;
      }

 //     console.log($ball.x, $ball.y, theta);
      $stick.transform({
        rotate: '' + theta + 'deg'
      }).css( 'height', '' + $ball.dist + 'px' );
    };

    // resizes the ball
    $ball.resize = function(){
      /*var phi = 90 - Math.asin($ball.dist/(RADIUS*2)).to_deg(),
          side = '' + BALLSIZE/(1+(90-phi)/160) + 'px';
      $ball.css('width', side)
           .css('height', side);*/
    }

    // adjust all things about the ball when the ball is animating
    var animate_ball = function(){
      var pos = $ball.position();
      $ball.x = pos.left - ORIGIN.left, 
      $ball.y = (pos.top - ORIGIN.top) * -1;
      $ball.dist = Math.sqrt($ball.x*$ball.x+$ball.y*$ball.y); // calculate ball's distance to center

      $stick.with_ball();
      $ball.resize();
    }

    $ball.draggable({
      containment: "parent",
      drag: animate_ball,
      stop: function(){
        $ball.animate({
          left: '' + ORIGIN.left + 'px', 
          top: '' + ORIGIN.top + 'px'
        }, {
          step: animate_ball
        });
      }
    });



    $('.verticle-slider').draggable({containment: "parent", axis:"y"});
  
  
  
    //----- COMMUNICATION PART
    var ws = new WebSocket(SOCKET_TARGET);
    ws.onopen = function(e){
      console.log("Socket opens.");
    }
    ws.onmessage = function(e){
      console.log(e.data);
    };


    var send_ball_coord = function(){
      if(ws.readyState === WebSocket.OPEN){
        // submit only if the ball is not in its original position.
        if($ball.position().left !== ORIGIN.left && $ball.position().top !== ORIGIN.top ) {
          var dx = Math.ceil($ball.x / HORIZONTAL_STEPSIZE - 0.5),
              dy = Math.ceil($ball.y / VERTIVAL_STEPSIZE - 0.5);
          ws.send("" + dx + " " + dy + " " + (new Date()).getUTCMilliseconds());
        }
      }
      
      setTimeout(arguments.callee, 200);
    };
    setTimeout(send_ball_coord, 200);
    

  </script>
</body>
</html>
